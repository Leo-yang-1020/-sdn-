## 负载均衡的理念：

在当今高可用网络基础架构的流行已经成为未来的趋势。网络流量的加重，使得越来越多的服务器的负担加重，而单机性能的提升远远跟不上负载的需求，由此提出的集群的部署这一解决方案，成为每一个公司，每一个项目必须关注的点。

集群要想最大功效发挥多节点处理的功效，就需要一个”调度者“，将用户的每一个请求按照相应的算法，分配到不同的服务器上，并保证此时各个节点都能被充分利用并且压力较小。SDN平台的控制器，可以完美地充当调度者这一角色

![preview](https://pic2.zhimg.com/v2-b3e69e976b5577457fcefc58f941fb8d_r.jpg)

#### 传统的负载均衡 VS SDN 平台负载均衡

**二层负载均衡** 

负载均衡服务器对外依然提供一个VIP（虚IP），集群中不同的机器采用相同IP地址，但是机器的MAC地址不一样。当负载均衡服务器接受到请求之后，通过改写报文的目标MAC地址的方式将请求转发到目标机器实现负载均衡。

**三层负载均衡**

和二层负载均衡类似，负载均衡服务器对外依然提供一个VIP（虚IP），但是集群中不同的机器采用不同的IP地址。当负载均衡服务器接受到请求之后，根据不同的负载均衡算法，通过IP将请求转发至不同的真实服务器。

**四层负载均衡** 

四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP/UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器。（LVS: linux 虚拟服务器）

**七层负载均衡** 

七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。 属于应用层方向（nginx，HAProxy）

##### SDN实现负载平衡的优势

传统网络必须要使用NAT技术，将多台相同的服务器映射为单个外网地址，对每次连接请求动态转换为一个内部服务器的地址，可以将外网的访问流量分发到每台服务器，实现负载均衡。但是传统的负载均衡技术存在许多的漏洞。

- 从容灾性的角度来看：由于NAT路由器无法感知服务器的故障，如果其中某一台服务器出现故障，路由器仍然会将数据转发到该服务器，会造成去往服务器集群的流量出现路由黑洞。
- 从执行效率的方面来看：由于NAT要在边界路由器上进行地址的转换，增大了传输的延迟。
- 从安全侦查的角度来看：由于NAT改动了IP地址，失去了跟踪端到端IP流量的能力。当出现恶意流量时，会使故障排除和流量跟踪变的更加棘手。
- 从资源开销的角度来看：处理NAT进程增加了CPU的负荷，并需要更多内存来存储NAT表项。

灵活可变的流表，实时的服务器怠机监测，控制器的高效处理，而通过SDN，就能够有效地解决上述问题。

#### 核心算法：

不同场景，不同算法实现，

对于所有节点具有相同功能的普通集群，采用：

普通的轮询算法没有考虑到不同的服务器的具体性能，因此存在一些漏洞。

平滑加权轮询算法

每一个服务器在初始时都有一个初始化的权重，而每次请求解决后会更新现有的权重，使得多个服务器即达到了轮询的效果，又避免了某台服务器的压力过大。

哈希散列算法

用于用户需要固定某一台服务器进行信息处理的场景：例如session的保存，或者用户在该服务器存储的信息等等

![img](https://user-gold-cdn.xitu.io/2019/3/8/1695db108ff3fcc7?imageslim)

![img](https://user-gold-cdn.xitu.io/2019/3/8/1695db10b98c15f1?imageslim)

利用顺时针哈希环，不同的用户会被分配到相同或者不同的服务器，但是一个用户无论何时请求，都会固定在同一个服务器。

#### 利用Iperf工具测试udp与tcp带宽

### 如何进行流量模拟？

> 我们需要通过程序来创造人工的网络流量,还原真实的环境

流量随机模型：主机向在网络中的另一任意主机以等概率发送数据包

我们可以使用mininet的iperf工具在网络中生成udp流量，iperf客户端传送数据流到iperf的服务端，由服务端接收并记录相关信息。

我们需要实现批处理流，实现自定义命令。



##### 使用何种工具？

>  Iperf是一个网络性能测试工具。Iperf可以测试TCP和UDP带宽质量。Iperf可以测量最大TCP带宽，具有多种参数和UDP特性。 Iperf可以报告带宽，延迟抖动和数据包丢失。利用Iperf这一特性，可以用来测试一些网络设备如路由器，防火墙，交换机等的性能。

mininet自带的iperf:仅仅能够通过随机选取两个主机，但是，在全局中，肯定不只是一个主机，因此，这样的带宽测试并不能让我们拥有良好的全局性视野，我们需要修改mininet的源码，我们自定义一个全局探测的带宽测试。

我们可以将测试得到的带宽数据存储在日志中，由此达到流量监控的作用。

一次测试可能存在所谓的抖动，偶然的情况，因此我们需要多次测试，多次数据可以对其进行处理，例如排除最高值并排除最低值，再取其平均值，作为主机间的带宽测试的真实值。

##### 修改Mininet的源码



#### 前端页面的展示

使用Canvas 接口绘制网络拓扑图。

带宽测试得到的数据可以利用gnuplot，一个命令行的交互式绘图工具可视化，便于管理人工实时查看评价算法。